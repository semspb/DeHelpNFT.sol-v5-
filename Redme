1️⃣ DeHelpNFT (NFT контракт)

Основная задача: выпуск NFT, хранение уровня и времени минта, уведомление RevenuePool при трансфере.

Функции и логика:

mint(to, level)

Минтит новый NFT для указанного адреса to.

Присваивает NFT уникальный tokenId.

Сохраняет:

время создания (mintTimestamp)

уровень NFT (level)

Генерирует событие NFTMinted.

Логика: простой учёт NFT и уровня, без финансовой логики.

_beforeTokenTransfer(from, to, tokenId, batchSize)

Хук, вызываемый при любом трансфере NFT.

Если трансфер не минт/сжигание, уведомляет RevenuePool через onNFTTransfer, чтобы скорректировать накопленные награды владельца.

Логика: обеспечивает автоматическое перераспределение дохода при смене владельца NFT.

setRevenuePool(newPool)

Админ может поменять адрес RevenuePool.

Логика: позволяет обновлять пул выплат, но требует доверия к администратору.

2️⃣ ReferralRegistry (реферальное дерево)

Основная задача: хранение связей «кто кого пригласил», проверка циклов, безопасный биндинг.

Функции и логика:

bindSponsor(tokenId, sponsorTokenId)

Привязывает NFT tokenId к спонсору sponsorTokenId.

Проверки:

NFT ещё не было привязано.

Пользователь не пытается привязать сам себя.

Циклы в дереве запрещены (максимальная глубина 11).

Привязку инициирует владелец NFT.

Логика: гарантирует корректное построение реферального дерева без циклов.

getUpline(tokenId, depth)

Возвращает спонсора на указанной глубине.

Логика: полезно для вычисления реферальных выплат на уровне 1–11.

getFullUpline(tokenId)

Возвращает массив всех спонсоров до максимальной глубины.

Логика: удобный инструмент для полного расчёта реферальной сети.

3️⃣ DistributionController (распределение платежей)

Основная задача: хранение процентных долей, по которым делятся средства при продаже NFT.

Функции и логика:

setDistribution(referral, pool, partners, treasury)

Админ задаёт доли в базисных пунктах (BPS, 10000 = 100%).

Проверка, чтобы сумма долей была ровно 100%.

Логика: позволяет динамически настраивать, сколько идёт на рефералов, пул дохода, партнёрам и казну.

split(amount)

Получив сумму amount, рассчитывает конкретные доли:

referralAmount = amount * referral / BPS

poolAmount = amount * pool / BPS

partnerAmount = amount * partners / BPS

treasuryAmount = остаток (для исключения пыли).

Логика: обеспечивает точное распределение каждой продажи.

getDistribution()

Возвращает текущие проценты для справки.

Особенность: дефолтная конфигурация задаёт безопасные доли (70% рефералы, 20% пул, 5% партнёры, 5% казна).

4️⃣ RevenuePool (пул доходов NFT)

Основная задача: хранить и распределять USDT между владельцами NFT на основе их доли.

Функции и логика:

deposit(amount)

Поступление средств в пул.

Распределяется пропорционально текущим shares.

Логика: увеличивает accRewardPerShare — коэффициент, по которому каждый NFT получает долю награды.

addShares(tokenId, shares)

Назначает NFT определённое количество долей для расчёта наград.

Перед добавлением: начисляются накопленные награды текущему владельцу в pending.

Логика: гарантирует корректное начисление, не теряя прошлые начисления.

harvest(tokenId)

Владелец NFT получает накопленные награды.

Логика: переводит их в pending, потом пользователь может вызвать claim.

claim()

Переводит pending USDT пользователю.

onNFTTransfer(tokenId, from, to)

Вызывается при трансфере NFT.

Начисляет накопленные награды старому владельцу, сбрасывает rewardDebt для нового.

Логика: автоматическое учёты смены владельца.

5️⃣ PartnerVault (партнёрский пул)

Основная задача: хранение и распределение наград для партнёров/совладельцев.

Функции и логика:

addOrUpdatePartner(partner, shares)

Добавляет нового партнёра или обновляет его долю.

Начисляет накопленные награды перед изменением доли.

Логика: управление распределением дохода между партнёрами.

deposit(amount)

Поступление средств в партнёрский пул.

Распределяется пропорционально shares.

harvest()

Начисляет награды партнёру в pending.

claim()

Выводит pending на счёт партнёра.

Особенность: структура идентична RevenuePool, только для партнёров, а не для NFT.

6️⃣ SaleMintController (продажа и распределение)

Основная задача: единая точка продажи NFT, распределение средств по всем пуллам, минт, биндинг спонсора.

Функции и логика:

mint(level, sponsorTokenId)

Пользователь платит basePrice + ownerFee.

Минтится NFT с указанным уровнем.

Если указан спонсор — привязывается через ReferralRegistry.

Средства делятся через DistributionController:

referralRegistry — перевод на выплаты рефералам

RevenuePool — депозит + начисление долей NFT

PartnerVault — депозит + начисление долей партнёрам

treasury — остаток

Логика: одна транзакция обеспечивает минт NFT + распределение дохода.

setPrices(basePrice, ownerFee)

Админ может менять цену NFT.

setTreasury(newTreasury)

Админ меняет адрес казны.

setDefaultSharesPerNFT(shares)

Админ задаёт базовое количество долей NFT в пуле.

pause() / unpause()

Останавливает или возобновляет продажи.

✅ Итоговая логика взаимодействия

Пользователь покупает NFT через SaleMintController.

NFT создаётся в DeHelpNFT.

Если есть спонсор, ReferralRegistry строит дерево.

DistributionController делит деньги на четыре потока.

RevenuePool получает средства и начисляет доли NFT.

PartnerVault получает средства и начисляет доли партнёрам.

Остаток идёт в казну.

При трансфере NFT RevenuePool автоматически пересчитывает награды.
